---
- name: Prepare/Configure host
  hosts: cmm-node
  sudo: yes
  vars_files:
    - credentials.yml
  environment:
    PIP_CONFIG_FILE: "{{ pip_config_file }}"
  pre_tasks:
    - include: tasks/set_up.yml tags=pre_tasks
    - include: tasks/verify_credentials.yml tags=schema,postgresql,api,persister,notification,thresh
  roles:
    - {role: pip, tags: [pip, resources]}
    - {role: cli-credentials, tags: [cli]}

- name: Monasca Installation
  hosts: cmm-node
  vars_files:
    - credentials.yml
  sudo: yes
  environment:
    PIP_CONFIG_FILE: "{{ pip_config_file }}"
  roles:
    - {role: zookeeper, tags: [zookeeper]}
    - {role: kafka, kafka_listen_address: "{{kafka_host}}", tags: [kafka]}
    - {role: influxdb, tags: [influxdb]}
    - {role: postgresql-redhat, when: ansible_os_family == 'RedHat', tags: [postgresql]}
    - {role: monasca-schema, database_admin_password: password, tags: [schema]} # FIXME:
    - {role: monasca-log-schema, tags: [elkstack]}
    - {role: monasca-api,
       api_region: useast,
       influxdb_user: mon_api,
       influxdb_password: password,
       database_user: monapi,
       database_password: "{{ database_monapi_password }}",
       monasca_api_tarball_base_url: "{{ world_repo_url }}",
       tags: [api]}
    - {role: monasca-log-api,
       api_region: useast,
       influxdb_user: mon_api,
       influxdb_password: password,
       database_user: monapi,
       database_password: "{{ database_logapi_password }}",
       monasca_log_api_tarball_base_url: "{{ world_repo_url }}",
       tags: [api, log_api]}
    - {role: monasca-persister,
       influxdb_user: mon_persister,
       influxdb_password: password,
       tags: [persister]}
    - {role: monasca-notification,
       database_user: notification,
       database_password: "{{ database_notification_password }}",
       smtp_host: localhost,
       tags: [notification]}
    - {role: storm,
       storm_nimbus_enabled: true,
       storm_supervisor_enabled: true,
       tags: [storm]}
    - {role: monasca-thresh,
       database_user: thresh,
       database_password: "{{ database_thresh_password }}",
       thresh_tarball_base_url: "{{ world_repo_url }}",
       tags: [thresh]}
    # elkstack
    - {role: monasca-elasticsearch,
      elasticsearch_download: "{{ world_repo_url }}",
      tags: [elkstack, elasticsearch]}
    - {role: monasca-kibana,
      kibana_download: "{{ world_repo_url }}",
      tags: [elkstack, kibana]}
    - {role: monasca-log-persister,
      logstash_download: "{{ world_repo_url }}",
      tags: [elkstack, log_persister]}
    - {role: monasca-log-transformer,
      logstash_download: "{{ world_repo_url }}",
      tags: [elkstack, log_transformer]}
    # elkstack
    - {role: logrotate, tags: [logrotate]}
    - {role: fujitsu-branding, tags: [branding]}

- name: Clean-Up host
  hosts: cmm-node
  sudo: yes
  post_tasks:
    - include: tasks/clean_up.yml tags=post_tasks
